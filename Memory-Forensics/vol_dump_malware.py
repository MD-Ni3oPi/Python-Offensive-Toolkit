#!/usr/bin/env python3
import subprocess
import sys
import os

# ==========================================
# CONFIGURATION
# ==========================================
VOL_PATH = "./vol.py"
MEMORY_FILE = "/root/Desktop/Windows_Snapshot3.vmem"
TARGET_PID = 8936

# We will create a safe folder to hold the extracted malware
DUMP_DIR = "./dumped_malware"


def extract_payload():
    if not os.path.exists(VOL_PATH):
        print(f"[!] ERROR: Cannot find {VOL_PATH}")
        return

    # Create the output directory if it doesn't exist
    if not os.path.exists(DUMP_DIR):
        os.makedirs(DUMP_DIR)
        print(f"[*] Created output directory: {DUMP_DIR}")

    print(f"[*] Extracting injected memory from PID {TARGET_PID}...")
    print("=" * 70)

    # Command: vol.py -f <file> -o <dump_dir> windows.malfind --pid 8936 --dump
    cmd = [
        sys.executable, VOL_PATH,
        "-f", MEMORY_FILE,
        "-o", DUMP_DIR,  # Tell Volatility where to save the files
        "windows.malfind",
        "--pid", str(TARGET_PID),
        "--dump"  # The magic extraction flag
    ]

    try:
        # We don't use JSON here because we want to read the standard output
        # to see the filenames Volatility generates.
        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode != 0 and "Volatility 3" not in result.stdout:
            print("[!] Volatility Failed:")
            print(result.stderr)
            return

        print("[+] Extraction process completed.")
        print("-" * 70)

        # Check if any files were actually created in our dump folder
        dumped_files = os.listdir(DUMP_DIR)

        if not dumped_files:
            print("[-] No files were extracted. The process might not have injected memory.")
        else:
            print("[+] SUCCESS! Malicious memory regions dumped to disk:")
            for file in dumped_files:
                file_path = os.path.join(DUMP_DIR, file)
                file_size = os.path.getsize(file_path)
                print(f"    -> {file} ({file_size} bytes)")

            print("\n[*] READY FOR ANALYSIS")
            print(f"    Navigate to the '{DUMP_DIR}' folder to examine the payload.")

    except Exception as e:
        print(f"[!] Unexpected Error: {e}")


if __name__ == '__main__':
    extract_payload()
